<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="cards.css" />
    <script
      defer
      src="https://kit.fontawesome.com/aa06e5f929.js"
      crossorigin="anonymous"
    ></script>
    <meta name="description" content="Rules of the game" />
    <link
      rel="shortcut icon"
      href="../assets/images/logo.png"
      type="image/x-icon"
    />
    <title>Cards</title>
  </head>
  <body>
    <header>
      <div class="logo">
        <img src="../assets/images/logo.png" alt="" />
      </div>
      <nav>
        <ul class="navbar-list">
          <li>
            <a href="/">
              <i class="fas fa-house"></i>
              <span class="nav-link">Home</span></a
            >
          </li>
          <li>
            <a href="/rules"
              ><i class="fas fa-clipboard-check"></i
              ><span class="nav-link">Rules</span></a
            >
          </li>
          <li>
            <a href="/cards"
              ><i class="fas fa-sheet-plastic"></i
              ><span class="nav-link">Cards</span></a
            >
          </li>
        </ul>
      </nav>
      <form class="search">
        <input
          id="searchInput"
          type="text"
          placeholder="Search..."
          oninput="search()"
        />
        <button id="submit-search" type="submit" aria-label="Submit button">
          <i class="fas fa-magnifying-glass"></i>
        </button>
      </form>
      <script>
        function search() {
          const searchTerm = document
            .getElementById("searchInput")
            .value.toLowerCase();

          const cards = document.querySelectorAll(".card-img");
          cards.forEach((card) => {
            const alt = card.getAttribute("alt").toLowerCase();
            if (alt.includes(searchTerm)) {
              card.parentElement.style.display = "flex";
            } else {
              card.parentElement.style.display = "none";
            }
          });
        }
      </script>
      <div class="login">
        <i class="fas fa-right-to-bracket"></i>
      </div>
      <div class="logout hidden">
        <i class="fas fa-user-large-slash"></i>
      </div>
      <div class="forms hidden">
        <form class="login-form" onsubmit="handleLogin(event)"
          <label for="login-email">Email adress</label>
          <input type="email" id="login-email" />
          <label for="llogin-password">Password</label>
          <input type="password" id="login-password" />
          <button type="submit">Login</button>

          <span class="tip">Register</span>
        </form>

        <form class="register-form hidden" onsubmit="handleRegister(event)">
          <label for="register-email">Email adress</label>
          <input type="email" id="register-email" />
          <label for="name">Username</label>
          <input type="text" id="name" />
          <label for="register-password">Password</label>
          <input type="password" id="register-password" />
          <button type="submit">Register</button>
          <span class="tip">Login</span>
        </form>
      </div>
      <script>
        const loginButton = document.querySelector(".login");
        const forms = document.querySelector(".forms");
        loginButton.addEventListener("click", () => {
          forms.classList.toggle("hidden");
        });

        function loginStatus() {
          if (localStorage.getItem("token")) {
            document.querySelector(".login").classList.add("hidden");
            document.querySelector(".logout").classList.remove("hidden");
          } else {
            document.querySelector(".login").classList.remove("hidden");
            document.querySelector(".logout").classList.add("hidden");
          }
        }
        loginStatus();

        function handleLogin(e) {
          e.preventDefault();
          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;
          fetch("/api/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          })
            .then((response) => response.json())
            .then((data) => {
              localStorage.setItem("token", data.token);
              forms.classList.add("hidden");
              loginStatus();
            })
            .catch((error) => {
              console.error("There was an error!", error);
            });
          }

          function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById("register-email").value;
            const name = document.getElementById("name").value;
            const password = document.getElementById("register-password").value;
            fetch("/api/users", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email, name, password }),
            })
              .then((response) => response.json())
              .then((data) => {
                localStorage.setItem("token", data.token);
                forms.classList.add("hidden");
                loginStatus();
              })
              .catch((error) => {
                console.error("There was an error!", error);
              });
          }
          
          logoutButton = document.querySelector(".logout");
          logoutButton.addEventListener("click", () => {
            localStorage.removeItem("token");
            loginStatus();
          });

          const tip = document.querySelectorAll(".tip");
          tip.forEach((element) => {
            element.addEventListener("click", () => {
              document.querySelector(".login-form").classList.toggle("hidden");
              document.querySelector(".register-form").classList.toggle("hidden");
            });
          });
      </script>

      <input type="checkbox" id="burger-toggle" />
      <label for="burger-toggle" class="burger-icon">
        <i class="fas fa-bars"></i>
      </label>
      <div class="burger-menu">
        <ul class="burger-menu-list">
          <li>
            <a href="/">
              <i class="fas fa-house"></i>
              <span>Home</span>
            </a>
          </li>
          <li>
            <a href="/rules">
              <i class="fas fa-clipboard-check"></i>
              <span>Rules</span>
            </a>
          </li>
          <li>
            <a href="/cards">
              <i class="fas fa-sheet-plastic"></i>
              <span>Cards</span>
            </a>
          </li>
        </ul>
      </div>
      <script defer>
        const burgerToggle = document.getElementById("burger-toggle");
        const burgerMenu = document.querySelector(".burger-menu");
        burgerToggle.addEventListener("change", () => {
          if (burgerToggle.checked) {
            burgerMenu.style.transform = "scaleY(1)";
          } else {
            burgerMenu.style.transform = "scaleY(0)";
          }
        });
      </script>
    </header>
    <div class="big-title">
      <h1>Characters</h1>
      <div class="tags-container"></div>
    </div>
    <main class="cards-container" id="cards-container">
      <!-- <div>
        <img
          class="card-img"
          src="../../assets/images/cards/HarryPotter.png"
          alt=""
        />
        <h4>Harry Potter</h4>
      </div> -->
      <script>
        const createCards = async () => {
          try {
            const tagList = [
              "gryffindor",
              "slytherin",
              "ravenclaw",
              "hufflepuff",
            ];
            const container = document.querySelector(".cards-container");

            function formatCheckboxTitle(string) {
              return " " + string.charAt(0).toUpperCase() + string.slice(1);
            }

            tagList.forEach((element) => {
              const tagsContainer = document.querySelector(".tags-container");
              const tag = document.createElement("label");
              tag.classList.add("tag");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.value = element;
              checkbox.addEventListener("change", () => {
                const cards = document.querySelectorAll(".card-img");
                const checkedTags = Array.from(
                  document.querySelectorAll(".tag input:checked")
                ).map((checkbox) => checkbox.value);
                cards.forEach((card) => {
                  if (
                    checkedTags.length === 0 ||
                    checkedTags.some((tag) => card.classList.contains(tag))
                  ) {
                    card.parentElement.style.display = "flex";
                  } else {
                    card.parentElement.style.display = "none";
                  }
                });
              });
              tag.appendChild(checkbox);
              tag.appendChild(
                document.createTextNode(formatCheckboxTitle(element))
              );
              tagsContainer.appendChild(tag);
            });

            const imageResponse = await fetch("/api/cards");
            const imageData = await imageResponse.json();
            imageData.forEach((element) => {
              container.appendChild(document.createElement("div"));
              const div = container.lastChild;
              div.id = element.id;
              div.classList.add("card");
              const house = element.house || "no-house";
              div.addEventListener("click", () => {
                if (localStorage.getItem("token")) {
                  fetch(`/api/latesthouse`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${localStorage.getItem("token")}`,
                    },
                    body: JSON.stringify({ house: house }),
                  })
                    .then((response) => {
                      if (response.status === 403) {
                        localStorage.removeItem("token");
                      }
                    })
                    .then(() => {
                      window.location.href = `?id=${div.id}`;
                    })
                    .catch((error) => {
                      console.error("There was an error!", error);
                    });
                } else {
                  window.location.href = `?id=${div.id}`;
                }
              });
              let img = document.createElement("img");
              img.classList.add("card-img");
              img.src = `/assets/images/cards/${element.image}`;
              img.alt = element.name;
              img.classList.add(element.house || "no-house");
              div.appendChild(img);
              let title = document.createElement("h4");
              title.innerText = element.name;
              div.appendChild(title);
            });
            showOnlyOneCard();
          } catch (error) {
            console.error("Erreur lors du traitement des images :", error);
          }
        };

        createCards();

        function showOnlyOneCard() {
          const urlParams = new URLSearchParams(window.location.search);
          const id = urlParams.get("id");

          if (id) {
            const cards = document.querySelectorAll(".card");
            cards.forEach((card) => {
              if (card.id !== id) {
                card.classList.add("card-hidden");
              }
            });
            document
              .getElementById("cards-container")
              .classList.add("cards-container-onlyone");
          }
        }
      </script>
    </main>
    <footer>
      <div class="socials">
        <a href="#"><i class="fab fa-youtube"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
      </div>
      <div class="legal">
        <a href="#">Terms of Use</a>
        <p>&middot;</p>
        <a href="#">Privacy Policy</a>
      </div>
      <div class="copyright">
        <p>&copy; Eric Hubert, <span id="copy-date"></span></p>
      </div>
      <script async type="module">
        document.getElementById("copy-date").innerText =
          new Date().getFullYear();
      </script>
    </footer>
  </body>
</html>
