<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="global.css" />
    <script
      defer
      src="https://kit.fontawesome.com/aa06e5f929.js"
      crossorigin="anonymous"
    ></script>
    <meta name="description" content="Harry Potter Trading Card Game" />
    <link
      rel="shortcut icon"
      href="assets/images/logo.png"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="profile.css" />
    <title>Harry Potter TCG</title>
  </head>
  <body>
    <header>
      <div class="logo">
        <img src="assets/images/logo.png" alt="" />
      </div>
      <nav>
        <ul class="navbar-list">
          <li>
            <a href="/">
              <i class="fas fa-house"></i>
              <span class="nav-link">Home</span></a
            >
          </li>
          <li>
            <a href="/rules"
              ><i class="fas fa-clipboard-check"></i
              ><span class="nav-link">Rules</span></a
            >
          </li>
          <li>
            <a href="/cards"
              ><i class="fas fa-sheet-plastic"></i
              ><span class="nav-link">Cards</span></a
            >
          </li>
        </ul>
      </nav>
      <div class="login">
        <i class="fas fa-right-to-bracket"></i>
      </div>
      <div class="user hidden">
        <i class="fas fa-user-large"></i>
      </div>
      <div class="forms hidden">
        <form class="login-form" onsubmit="handleLogin(event)">
          <label for="login-email">Email adress</label>
          <input type="email" id="login-email" />
          <label for="login-password">Password</label>
          <input type="password" id="login-password" />
          <button type="submit">Login</button>

          <span class="tip">Register</span>
        </form>

        <form class="register-form hidden" onsubmit="handleRegister(event)">
          <label for="register-email">Email adress</label>
          <input type="email" id="register-email" />
          <label for="name">Username</label>
          <input type="text" id="name" />
          <label for="register-password">Password</label>
          <input type="password" id="register-password" />
          <button type="submit">Register</button>
          <span class="tip">Login</span>
        </form>

        <div class="user-menu hidden">
          <p class="user-name"></p>
          <p class="user-email"></p>
          <a href="/profile"><button>Profil</button></a>
          <button class="logout">
            <i class="fas fa-user-large-slash"></i>Logout
          </button>
        </div>
      </div>
      <script>
        const loginButton = document.querySelector(".login");
        const forms = document.querySelector(".forms");
        loginButton.addEventListener("click", () => {
          forms.classList.toggle("hidden");
        });

        function loginStatus() {
          if (localStorage.getItem("token")) {
            document.querySelector(".login").classList.add("hidden");
            document.querySelector(".user").classList.remove("hidden");
            document.querySelector(".forms").classList.add("hidden");
          } else {
            document.querySelector(".login").classList.remove("hidden");
            document.querySelector(".user").classList.add("hidden");
            document.querySelector(".forms").classList.add("hidden");
            document.querySelector(".user-menu").classList.add("hidden");
            document.querySelector(".login-form").classList.remove("hidden");
          }
        }
        loginStatus();

        function handleLogin(e) {
          e.preventDefault();
          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;
          fetch("/api/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          })
            .then((response) => response.json())
            .then((data) => {
              localStorage.setItem("token", data.token);
              forms.classList.add("hidden");
              document.querySelector("#login-email").value = "";
              document.querySelector("#login-password").value = "";
              loginStatus();
            })
            .catch((error) => {
              console.error("There was an error!", error);
            });
        }

        function handleRegister(e) {
          e.preventDefault();
          const email = document.getElementById("register-email").value;
          const name = document.getElementById("name").value;
          const password = document.getElementById("register-password").value;
          fetch("/api/users", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, name, password }),
          })
            .then((response) => response.json())
            .then((data) => {
              localStorage.setItem("token", data.token);
              forms.classList.add("hidden");
              loginStatus();
            })
            .catch((error) => {
              console.error("There was an error!", error);
            });
        }

        const logoutButton = document.querySelector(".logout");
        logoutButton.addEventListener("click", () => {
          localStorage.removeItem("token");
          window.location.href = "/";
          loginStatus();
        });

        const userMenuButton = document.querySelector(".user");
        const userMenu = document.querySelector(".user-menu");
        const loginForm = document.querySelector(".login-form");
        userMenuButton.addEventListener("click", () => {
          forms.classList.toggle("hidden");
          userMenu.classList.toggle("hidden");
          loginForm.classList.add("hidden");
          fetch("/api/profile", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          })
            .then((response) => response.json())
            .then((data) => {
              document.querySelector(".user-name").innerText = data.name;
              document.querySelector(".user-email").innerText = data.email;
            })
            .catch((error) => {
              console.error("There was an error!", error);
            });
        });

        const tip = document.querySelectorAll(".tip");
        tip.forEach((element) => {
          element.addEventListener("click", () => {
            document.querySelector(".login-form").classList.toggle("hidden");
            document.querySelector(".register-form").classList.toggle("hidden");
          });
        });
      </script>
      <input type="checkbox" id="burger-toggle" />
      <label for="burger-toggle" class="burger-icon">
        <i class="fas fa-bars"></i>
      </label>
      <div class="burger-menu">
        <ul class="burger-menu-list">
          <li>
            <a href="/">
              <i class="fas fa-house"></i>
              <span>Home</span>
            </a>
          </li>
          <li>
            <a href="/rules">
              <i class="fas fa-clipboard-check"></i>
              <span>Rules</span>
            </a>
          </li>
          <li>
            <a href="/cards">
              <i class="fas fa-sheet-plastic"></i>
              <span>Cards</span>
            </a>
          </li>
        </ul>
      </div>
      <script defer>
        const burgerToggle = document.getElementById("burger-toggle");
        const burgerMenu = document.querySelector(".burger-menu");
        burgerToggle.addEventListener("change", () => {
          if (burgerToggle.checked) {
            burgerMenu.style.transform = "scaleY(1)";
          } else {
            burgerMenu.style.transform = "scaleY(0)";
          }
        });
      </script>
    </header>
    <main>
      <div class="profile">
        <div class="big-title">
          <h1>Profil</h1>
          <div class="profile-items">
            <p>
              Nom <span id="profile-name"></span>
              <i class="fas fa-signature"></i>
            </p>
            <p>
              Adresse e-mail <span id="profile-email"></span
              ><i class="fas fa-at"></i>
            </p>
            <p>
              Dernière maison visitée <span id="profile-house"></span
              ><i class="fa fa-house"></i>
            </p>
            <p>
              Ouvrir un booster
              <button id="profile-isboosteravailable">Ouvrir</button>
              <i class="fas fa-file-circle-plus"></i>
            </p>
          </div>
        </div>
        <div class="big-title">
          <h1>Vos cartes</h1>
          <div class="tags-container">Filtres :</div>
          <div class="cards-container" id="cards-container">
            <!-- <div>
                <img
                class="card-img"
                src="../../assets/images/cards/HarryPotter.png"
                alt=""
                />
                <h4>Harry Potter</h4>
            </div> -->
          </div>
        </div>
      </div>
      <script>
        window.addEventListener("pageshow", (event) => {
          if (event.persisted) {
            window.location.reload();
          }
          if (performance.navigation.type == 2) {
            location.reload();
          }
        });
        fetch("/api/profile", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("profile-name").innerText = data.name;
            document.getElementById("profile-email").innerText = data.email;
            document.getElementById("profile-house").innerText =
              capitalizeFirstLetter(data.lastHouseVisited);
          })
          .catch((error) => {
            localStorage.removeItem("token");
            window.location.href = "/";
          });
        const updateBoosterButton = () => {
          fetch("/api/usercards/canuseropenbooster", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          })
            .then((response) => response.json())
            .then((data) => {
              document.getElementById("profile-isboosteravailable").disabled =
                !data.canOpen;
              if (!data.canOpen) {
                fetch("/api/usercards/timeuntilnextbooster", {
                  headers: {
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                })
                  .then((response) => response.json())
                  .then((data) => {
                    const timeInSeconds = data.timeUntilNextBooster;
                    const hours = Math.floor(timeInSeconds / 1000 / 60 / 60);
                    const minutes = Math.floor(
                      (timeInSeconds / 1000 / 60) % 60
                    );
                    document.getElementById(
                      "profile-isboosteravailable"
                    ).innerText = `Disponible dans ${hours}h${minutes
                      .toString()
                      .padStart(2, "0")}m`;
                  })
                  .catch((error) => {
                    console.error("There was an error!", error);
                  });
              }
            })
            .catch((error) => {
              console.error("There was an error!", error);
            });
        };
        updateBoosterButton();
        document
          .getElementById("profile-isboosteravailable")
          .addEventListener("click", () => {
            fetch("/api/usercards/openbooster", {
              method: "GET",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            })
              .then((response) => response.json())
              .then((data) => {
                createCards();
                updateBoosterButton();
              })
              .catch((error) => {
                console.error("There was an error!", error);
              });
          });
      </script>
      <script>
        const createCards = async () => {
          try {
            const tagList = [
              "gryffindor",
              "slytherin",
              "ravenclaw",
              "hufflepuff",
            ];
            const container = document.querySelector(".cards-container");
            container.innerHTML = "";
            const tagsContainer = document.querySelector(".tags-container");

            tagsContainer.innerHTML = "Filtres :";
            function formatCheckboxTitle(string) {
              return " " + string.charAt(0).toUpperCase() + string.slice(1);
            }

            tagList.forEach((element) => {
              const tag = document.createElement("label");
              tag.classList.add("tag");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.value = element;
              checkbox.addEventListener("change", () => {
                const cards = document.querySelectorAll(".card-img");
                const checkedTags = Array.from(
                  document.querySelectorAll(".tag input:checked")
                ).map((checkbox) => checkbox.value);
                cards.forEach((card) => {
                  if (
                    checkedTags.length === 0 ||
                    checkedTags.some((tag) => card.classList.contains(tag))
                  ) {
                    card.parentElement.style.display = "flex";
                  } else {
                    card.parentElement.style.display = "none";
                  }
                });
              });
              tag.appendChild(checkbox);
              tag.appendChild(
                document.createTextNode(formatCheckboxTitle(element))
              );
              tagsContainer.appendChild(tag);
            });

            const imageResponse = await fetch("/api/usercards", {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            });
            const userCardData = await imageResponse.json();
            userCardData.forEach((element) => {
              container.appendChild(document.createElement("div"));
              const div = container.lastChild;
              div.id = element.card.id;
              div.classList.add("card");
              const house = element.card.house || "no-house";
              div.addEventListener("click", () => {
                if (localStorage.getItem("token")) {
                  fetch(`/api/latesthouse`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${localStorage.getItem("token")}`,
                    },
                    body: JSON.stringify({ house: house }),
                  })
                    .then((response) => {
                      if (response.status === 403) {
                        localStorage.removeItem("token");
                      }
                    })
                    .then(() => {
                      window.location.href = `/cards?id=${div.id}`;
                    })
                    .catch((error) => {
                      console.error("There was an error!", error);
                    });
                } else {
                  window.location.href = `/cards?id=${div.id}`;
                }
              });
              let img = document.createElement("img");
              img.classList.add("card-img");
              img.src = `/assets/images/cards/${element.card.image}`;
              img.alt = element.card.name;
              img.classList.add(element.card.house || "no-house");
              div.appendChild(img);
              const fav = document.createElement("i");
              fav.classList.add("fa-star");
              if (element.isFavorite) {
                fav.classList.add("fa-solid");
              } else {
                fav.classList.add("fa-regular");
              }
              fav.addEventListener("click", () => {
                event.stopPropagation();
                fetch("/api/usercards/favorite", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                  body: JSON.stringify({
                    cardId: element.card.id,
                    setTo: !element.isFavorite,
                  }),
                }).then(() => createCards());
              });
              div.appendChild(fav);
              const houseName = document.createElement("p");
              houseName.innerText =
                capitalizeFirstLetter(element.card.house) || "Pas de maison";
              houseName.classList.add("house-name");
              switch (element.card.house) {
                case "gryffindor":
                  houseName.style.color = "red";
                  break;
                case "slytherin":
                  houseName.style.color = "green";
                  break;
                case "ravenclaw":
                  houseName.style.color = "blue";
                  break;
                case "hufflepuff":
                  houseName.style.color = "olive";
                  break;
                default:
                  houseName.style.color = "black";
              }
              div.appendChild(houseName);
              let title = document.createElement("h4");
              title.innerText = element.card.name;
              div.appendChild(title);
            });
          } catch (error) {
            console.error("Erreur lors du traitement des images :", error);
          }
        };

        createCards();

        function capitalizeFirstLetter(string) {
          return string.charAt(0).toUpperCase() + string.slice(1);
        }
      </script>
    </main>
    <footer>
      <div class="socials">
        <a href="#"><i class="fab fa-youtube"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
      </div>
      <div class="legal">
        <a href="#">Terms of Use</a>
        <p>&middot;</p>
        <a href="#">Privacy Policy</a>
      </div>
      <div class="copyright">
        <p>&copy; Eric Hubert, <span id="copy-date"></span></p>
      </div>
      <script async type="module">
        document.getElementById("copy-date").innerText =
          new Date().getFullYear();
      </script>
    </footer>
  </body>
</html>
